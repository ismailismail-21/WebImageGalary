{% extends "base.html" %}

{% block title %}Gallery - {{ folder_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') }}">
{% endblock %}

{% block folders_nav %}
<!-- Folders Navigation Bar -->
<div class="folders-nav">
    <div class="folders-nav-container">
        <div class="folders-nav-list">
            {% for folder in folders %}
            <a href="/folder/{{ folder.path }}"
                class="folder-nav-link {% if folder.path == folder_name %}active{% endif %}">
                {{ folder.name }}
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block breadcrumb %}
<!-- Breadcrumb Navigation with Hide Tags Button -->
<div class="breadcrumb-nav">
    <span class="breadcrumb-item"><a href="/">Home</a></span>
    {% for crumb in breadcrumbs %}
    <span class="breadcrumb-item">/</span>
    <span class="breadcrumb-item"><a href="/folder/{{ crumb.path }}">{{ crumb.name }}</a></span>
    {% endfor %}
    <button id="hideTagsBtn" class="hide-tags-btn" onclick="toggleAllTags()" title="Hide/Show tags">Hide Tags</button>
</div>
{% endblock %}

{% block content %}
<!-- Folder Header -->
<div class="folder-header">
    <div class="header-content">
        {% if breadcrumbs|length > 1 %}
        <a href="/folder/{{ breadcrumbs[-2].path }}" class="back-link">‚Üê Back to {{ breadcrumbs[-2].name }}</a>
        {% else %}
        <a href="/" class="back-link">‚Üê Back to Home</a>
        {% endif %}
        <h1>{{ breadcrumbs[-1].name if breadcrumbs else folder_name }}</h1>
        <p class="image-count">
            {% if subfolders %}{{ subfolders|length }} subfolder{{ 's' if subfolders|length > 1 else '' }}{% if
            total_images > 0 %}, {% endif %}{% endif %}
            {% if total_images > 0 %}{{ total_images }} image{{ 's' if total_images > 1 else '' }}{% endif %}
        </p>
    </div>
</div>

<!-- Subfolders Section -->
{% if subfolders or total_subfolders > 0 %}
<div class="subfolders-section">
    <h3>üìÅ Subfolders ({{ total_subfolders }})</h3>
    <div class="subfolders-grid" id="subfoldersGrid">
        {% for subfolder in subfolders %}
        <a href="/folder/{{ subfolder.path }}" class="subfolder-card">
            <div class="subfolder-thumbnail">
                {% if subfolder.thumbnail %}
                <img src="/api/image/{{ subfolder.thumbnail }}" alt="{{ subfolder.name }}" class="subfolder-thumb-img"
                    loading="lazy">
                {% else %}
                <div class="subfolder-icon-fallback">
                    {% if subfolder.has_subfolders %}üìÅ{% else %}üñºÔ∏è{% endif %}
                </div>
                {% endif %}
            </div>
            <div class="subfolder-overlay">
                <div class="subfolder-name">{{ subfolder.name }}</div>
                <div class="subfolder-info">
                    {% if subfolder.has_subfolders %}
                    <span class="subfolder-meta">{{ subfolder.subfolder_count }} folder{{ 's' if
                        subfolder.subfolder_count >
                        1 else '' }}</span>
                    {% endif %}
                    {% if subfolder.count > 0 %}
                    <span class="subfolder-meta">{{ subfolder.count }} image{{ 's' if subfolder.count > 1 else ''
                        }}</span>
                    {% endif %}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% if has_more_subfolders %}
    <div style="text-align: center; margin-top: 20px;">
        <button id="loadMoreSubfoldersBtn" class="load-more-btn" onclick="loadMoreSubfolders()">
            Load More Subfolders
        </button>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Gallery Container -->
{% if total_images > 0 %}
<div class="gallery-container" id="galleryContainer">
    <h3 style="margin: 20px 0 15px 0; color: #666; font-size: 1.1em;">Images in this folder ({{ total_images }})</h3>
    <div class="images-grid" id="imagesGrid">
        {% for image in images %}
        <div class="grid-item" data-filename="{{ image.filename }}" data-folder="{{ folder_name }}"
            data-is-video="{{ 'true' if image.get('is_video') else 'false' }}"
            style="width: {{ image.get('calc_width', 200) }}px; height: {{ image.get('calc_height', 200) }}px;">

            {% if image.get('is_video') %}
            <video class="gallery-image gallery-video" data-width="{{ image.width }}" data-height="{{ image.height }}"
                preload="metadata" onclick="openLightbox(this)" loop muted playsinline webkit-playsinline
                crossorigin="anonymous">
                <source src="/api/image/{{ folder_name }}/{{ image.filename }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="video-play-icon">‚ñ∂</div>
            <div class="video-duration" id="duration-{{ image.filename }}">0:00</div>
            {% else %}
            <img src="/api/image/{{ folder_name }}/{{ image.filename }}" alt="{{ image.filename }}"
                class="gallery-image" data-width="{{ image.width }}" data-height="{{ image.height }}" loading="lazy"
                onclick="openLightbox(this)" crossorigin="anonymous">
            {% endif %}

            <!-- Image Controls (Heart and Delete) -->
            <div class="image-controls">
                <button class="heart-btn"
                    onclick="event.stopPropagation(); toggleImageFavorite('{{ folder_name }}', '{{ image.filename }}', this)"
                    title="Add to favorites">‚ô°</button>
                <button class="delete-btn"
                    onclick="event.stopPropagation(); deleteImage('{{ folder_name }}', '{{ image.filename }}', this)"
                    title="Delete image">üóëÔ∏è</button>
            </div>

            <!-- Tag Dropdown Inline -->
            <div class="tag-dropdown" id="tag-dropdown-{{ image.filename }}" style="display: none;">
                <div class="tag-dropdown-content" id="tag-list-{{ image.filename }}">
                    <!-- Tags will be loaded here -->
                </div>
            </div>

            <!-- Tag Circle Button -->
            <button class="tag-circle-btn"
                onclick="event.stopPropagation(); toggleTagDropdown('{{ folder_name }}', '{{ image.filename }}')"
                title="Manage tags">+</button>

            <!-- Image Tags Display -->
            <div class="image-tags" id="tags-{{ image.filename }}"></div>
        </div>
        {% endfor %}
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
        <div class="spinner"></div>
        <p style="color: #666; margin-top: 10px;">Loading more images...</p>
    </div>

    <!-- Load More Button -->
    <div id="loadMoreContainer" style="text-align: center; margin: 20px 0; display: none;">
        <button id="loadMoreBtn" class="load-more-btn" onclick="loadMoreImages()">
            Load More Images
        </button>
    </div>
</div>
{% endif %}

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
    <div class="lightbox-container">
        <img id="lightboxImage" src="" alt="" class="lightbox-image">
        <video id="lightboxVideo" class="lightbox-image" controls loop muted playsinline webkit-playsinline
            crossorigin="anonymous" style="display: none;">
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <div class="lightbox-info">
            <span id="lightboxCounter">1 / 1</span>
        </div>

        <div class="lightbox-controls">
            <button class="lightbox-fullscreen-btn" id="lightboxFullscreenBtn"
                onclick="event.stopPropagation(); toggleFullscreen()" title="Toggle fullscreen">‚õ∂</button>
            <button class="lightbox-slideshow-btn" id="lightboxSlideshowBtn"
                title="Start slideshow (Spacebar)">‚ñ∂</button>
            <button class="lightbox-delete-btn" id="lightboxDeleteBtn"
                onclick="event.stopPropagation(); deleteLightboxImage()" title="Delete image">üóëÔ∏è</button>
            <button class="lightbox-favorite-btn" id="lightboxFavoriteBtn"
                onclick="event.stopPropagation(); toggleLightboxFavorite()" title="Add to favorites">‚ô°</button>
            <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
        </div>

        <button class="lightbox-nav lightbox-prev" onclick="prevImage()">‚Äπ</button>
        <button class="lightbox-nav lightbox-next" onclick="nextImage()">‚Ä∫</button>
    </div>
</div>

<!-- Tag Modal -->
<div id="tagModal" class="tag-modal">
    <div class="tag-modal-content">
        <div class="tag-modal-header">
            <h2>Manage Tags</h2>
            <button class="tag-modal-close" onclick="closeTagModal()">‚úï</button>
        </div>

        <div class="tag-modal-body">
            <!-- Existing Tags -->
            <div class="tag-section">
                <h3>Available Tags</h3>
                <div id="existingTags"></div>
            </div>

            <!-- Create New Tag -->
            <div class="new-tag-form">
                <h3>Create New Tag</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="newTagInput" placeholder="Tag name" style="flex: 1; padding: 8px;" />
                    <input type="color" id="newTagColor" value="#3498db" style="width: 50px;" />
                    <button onclick="createNewTag()"
                        style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
<script>
    // Initialize gallery data
    const folderName = '{{ folder_name }}';
    let allTags = {{ tags | tojson }};
    let tagsVisible = true;

    // Lazy loading state
    let currentImagePage = 1;
    let currentSubfolderPage = 1;
    let isLoadingImages = false;
    let isLoadingSubfolders = false;
    let hasMoreImages = {{ 'true' if images| length < total_images else 'false' }};
    let totalImages = {{ total_images }};
    let loadedImages = {{ images| length }};

    // Load tags and favorites for all images
    document.addEventListener('DOMContentLoaded', () => {
        loadTagsAndFavorites();
        setupIntersectionObserver();
        updateLoadMoreButton();
    });

    function loadTagsAndFavorites() {
        // Load all images
        const images = document.querySelectorAll('.grid-item');
        images.forEach(item => {
            const folder = item.dataset.folder;
            const filename = item.dataset.filename;

            // Load tags for this image
            loadImageTags(folder, filename);

            // Check if favorited
            checkImageFavorite(folder, filename);
        });
    }

    function loadImageTags(folder, filename) {
        fetch(`/api/image-tags/${folder}/${filename}`)
            .then(r => r.json())
            .then(imageTags => {
                const tagsContainer = document.getElementById(`tags-${filename}`);
                if (tagsContainer && imageTags && imageTags.length > 0) {
                    const tagHtml = imageTags
                        .map(it => `<span class="tag-badge" style="background-color: ${it.tag.color}">${it.tag.name}</span>`)
                        .join('');
                    tagsContainer.innerHTML = tagHtml;
                } else if (tagsContainer) {
                    tagsContainer.innerHTML = '';
                }
            })
            .catch(err => console.error('Error loading tags:', err));
    }

    function checkImageFavorite(folder, filename) {
        fetch(`/api/favorite/${folder}/${filename}`)
            .then(r => r.json())
            .then(data => {
                const gridItem = document.querySelector(`[data-folder="${folder}"][data-filename="${filename}"]`);
                const heartBtn = gridItem?.querySelector('.heart-btn');
                if (heartBtn && data.is_favorite) {
                    heartBtn.classList.add('active');
                    heartBtn.textContent = '‚ô•';
                }
            })
            .catch(err => console.error('Error checking favorite:', err));
    }

    function toggleAllTags() {
        tagsVisible = !tagsVisible;
        const tagsElements = document.querySelectorAll('.image-tags');
        const btn = document.getElementById('hideTagsBtn');

        tagsElements.forEach(el => {
            el.style.display = tagsVisible ? 'flex' : 'none';
        });

        btn.textContent = tagsVisible ? 'Hide Tags' : 'Show Tags';
    }

    // Toggle tag dropdown for an image
    function toggleTagDropdown(folder, filename) {
        const dropdown = document.getElementById(`tag-dropdown-${filename}`);
        const tagList = document.getElementById(`tag-list-${filename}`);

        // Close all other dropdowns
        document.querySelectorAll('.tag-dropdown').forEach(d => {
            if (d.id !== `tag-dropdown-${filename}`) {
                d.style.display = 'none';
            }
        });

        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
            // Load tags and show dropdown
            loadTagsForDropdown(folder, filename);
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }

    // Load tags into dropdown
    function loadTagsForDropdown(folder, filename) {
        const tagList = document.getElementById(`tag-list-${filename}`);
        if (!tagList) return;

        // Fetch all tags
        fetch('/api/tags')
            .then(r => r.json())
            .then(allTags => {
                if (allTags.length === 0) {
                    tagList.innerHTML = '<div style="padding: 12px; color: #999; text-align: center; font-size: 0.85em;">No tags available<br><a href="/tags" style="color: #667eea;">Create tags</a></div>';
                    return;
                }

                // Fetch current image tags
                fetch(`/api/image-tags/${folder}/${filename}`)
                    .then(r => r.json())
                    .then(imageTags => {
                        // imageTags is an array of ImageTag objects with nested tag objects
                        const currentTagIds = imageTags.map(it => it.tag_id);

                        console.log('Image tags for', filename, ':', imageTags);
                        console.log('Current tag IDs:', currentTagIds);

                        const tagHtml = allTags.map(tag => {
                            const isActive = currentTagIds.includes(tag.id);
                            console.log(`Tag ${tag.name} (id: ${tag.id}): isActive = ${isActive}`);
                            return `
                                <div class="tag-dropdown-item ${isActive ? 'active' : ''}" 
                                     style="border-left-color: ${tag.color}"
                                     onclick="toggleTagForImage('${folder}', '${filename}', ${tag.id}, this)">
                                    <input type="checkbox" 
                                           class="tag-dropdown-checkbox" 
                                           ${isActive ? 'checked' : ''}
                                           onclick="event.stopPropagation();">
                                    <span>${tag.name}</span>
                                </div>
                            `;
                        }).join('');

                        tagList.innerHTML = tagHtml;
                    });
            })
            .catch(err => {
                console.error('Error loading tags:', err);
                tagList.innerHTML = '<div style="padding: 12px; color: #e74c3c;">Error loading tags</div>';
            });
    }

    // Toggle tag assignment for image
    function toggleTagForImage(folder, filename, tagId, element) {
        const checkbox = element.querySelector('.tag-dropdown-checkbox');
        const isCurrentlyActive = checkbox.checked;

        // Toggle checkbox immediately for instant feedback
        checkbox.checked = !isCurrentlyActive;

        // Call API
        const method = isCurrentlyActive ? 'DELETE' : 'POST';
        fetch(`/api/image-tag/${folder}/${filename}/${tagId}`, {
            method: method
        })
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('Tag toggle response:', data);
                if (data.success) {
                    // Update UI classes
                    if (isCurrentlyActive) {
                        element.classList.remove('active');
                    } else {
                        element.classList.add('active');
                    }

                    // Force reload tags display for this image with a small delay
                    setTimeout(() => {
                        loadImageTags(folder, filename);
                    }, 100);
                } else {
                    // Revert checkbox on error
                    checkbox.checked = isCurrentlyActive;
                    console.error('Tag toggle failed:', data.message);
                    showNotification('Error: ' + (data.message || 'Failed to update tag'), 'error');
                }
            })
            .catch(err => {
                console.error('Error toggling tag:', err);
                // Revert checkbox on error
                checkbox.checked = isCurrentlyActive;
                showNotification('Error updating tag', 'error');
            });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.tag-circle-btn') && !e.target.closest('.tag-dropdown')) {
            document.querySelectorAll('.tag-dropdown').forEach(d => {
                d.style.display = 'none';
            });
        }
    });

    // Lazy Loading Functions
    function setupIntersectionObserver() {
        // Only setup if there are more images to load
        if (!hasMoreImages) return;

        const options = {
            root: null,
            rootMargin: '200px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMoreImages && !isLoadingImages) {
                    loadMoreImages();
                }
            });
        }, options);

        // Observe the load more container
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        if (loadMoreContainer) {
            loadMoreContainer.style.display = 'block';
            observer.observe(loadMoreContainer);
        }
    }

    function updateLoadMoreButton() {
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        if (hasMoreImages) {
            loadMoreContainer.style.display = 'block';
            loadMoreBtn.textContent = `Load More (${loadedImages} / ${totalImages})`;
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }

    async function loadMoreImages() {
        if (isLoadingImages || !hasMoreImages) return;

        isLoadingImages = true;
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        loadingIndicator.style.display = 'block';
        loadMoreBtn.disabled = true;

        try {
            currentImagePage++;
            const response = await fetch(`/api/images/${folderName}?page=${currentImagePage}&per_page=50`);
            const data = await response.json();

            if (data.images && data.images.length > 0) {
                const imagesGrid = document.getElementById('imagesGrid');

                data.images.forEach(image => {
                    const gridItem = createImageGridItem(image);
                    imagesGrid.appendChild(gridItem);

                    // Load tags and favorites for new image
                    loadImageTags(folderName, image.filename);
                    checkImageFavorite(folderName, image.filename);
                });

                loadedImages += data.images.length;
                hasMoreImages = data.has_more;

                // Update all images array for lightbox
                loadAllImages();
            }

            updateLoadMoreButton();
        } catch (error) {
            console.error('Error loading more images:', error);
            showNotification('Error loading more images', 'error');
        } finally {
            isLoadingImages = false;
            loadingIndicator.style.display = 'none';
            loadMoreBtn.disabled = false;
        }
    }

    function createImageGridItem(image) {
        const gridItem = document.createElement('div');
        gridItem.className = 'grid-item';
        gridItem.dataset.filename = image.filename;
        gridItem.dataset.folder = folderName;
        gridItem.dataset.isVideo = image.is_video ? 'true' : 'false';
        gridItem.style.width = `${image.calc_width || 200}px`;
        gridItem.style.height = `${image.calc_height || 200}px`;

        const mediaHtml = image.is_video ? `
            <video class="gallery-image gallery-video" data-width="${image.width}" data-height="${image.height}"
                preload="metadata" onclick="openLightbox(this)" loop muted playsinline>
                <source src="/api/image/${folderName}/${image.filename}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="video-play-icon">‚ñ∂</div>
            <div class="video-duration" id="duration-${image.filename}">0:00</div>
        ` : `
            <img src="/api/image/${folderName}/${image.filename}" 
                 alt="${image.filename}"
                 class="gallery-image" 
                 data-width="${image.width}" 
                 data-height="${image.height}"
                 loading="lazy"
                 onclick="openLightbox(this)">
        `;

        gridItem.innerHTML = `
            ${mediaHtml}
            
            <div class="image-controls">
                <button class="heart-btn"
                    onclick="event.stopPropagation(); toggleImageFavorite('${folderName}', '${image.filename}', this)"
                    title="Add to favorites">‚ô°</button>
                <button class="delete-btn"
                    onclick="event.stopPropagation(); deleteImage('${folderName}', '${image.filename}', this)"
                    title="Delete image">üóëÔ∏è</button>
            </div>
            
            <div class="tag-dropdown" id="tag-dropdown-${image.filename}" style="display: none;">
                <div class="tag-dropdown-content" id="tag-list-${image.filename}">
                </div>
            </div>
            
            <button class="tag-circle-btn"
                onclick="event.stopPropagation(); toggleTagDropdown('${folderName}', '${image.filename}')"
                title="Manage tags">+</button>
            
            <div class="image-tags" id="tags-${image.filename}"></div>
        `;

        return gridItem;
    }

    async function loadMoreSubfolders() {
        if (isLoadingSubfolders) return;

        isLoadingSubfolders = true;
        const btn = document.getElementById('loadMoreSubfoldersBtn');
        btn.disabled = true;
        btn.textContent = 'Loading...';

        try {
            currentSubfolderPage++;
            const response = await fetch(`/api/subfolders/${folderName}?page=${currentSubfolderPage}&per_page=20`);
            const data = await response.json();

            if (data.subfolders && data.subfolders.length > 0) {
                const subfoldersGrid = document.getElementById('subfoldersGrid');

                data.subfolders.forEach(subfolder => {
                    const card = createSubfolderCard(subfolder);
                    subfoldersGrid.appendChild(card);
                });

                if (!data.has_more) {
                    btn.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Error loading more subfolders:', error);
            showNotification('Error loading more subfolders', 'error');
        } finally {
            isLoadingSubfolders = false;
            btn.disabled = false;
            btn.textContent = 'Load More Subfolders';
        }
    }

    function createSubfolderCard(subfolder) {
        const card = document.createElement('a');
        card.href = `/folder/${subfolder.path}`;
        card.className = 'subfolder-card';

        const thumbnailHtml = subfolder.thumbnail
            ? `<img src="/api/image/${subfolder.thumbnail}" alt="${subfolder.name}" class="subfolder-thumb-img" loading="lazy">`
            : `<div class="subfolder-icon-fallback">${subfolder.has_subfolders ? 'üìÅ' : 'üñºÔ∏è'}</div>`;

        const folderInfo = [];
        if (subfolder.has_subfolders) {
            folderInfo.push(`<span class="subfolder-meta">${subfolder.subfolder_count} folder${subfolder.subfolder_count > 1 ? 's' : ''}</span>`);
        }
        if (subfolder.count > 0) {
            folderInfo.push(`<span class="subfolder-meta">${subfolder.count} image${subfolder.count > 1 ? 's' : ''}</span>`);
        }

        card.innerHTML = `
            <div class="subfolder-thumbnail">
                ${thumbnailHtml}
            </div>
            <div class="subfolder-overlay">
                <div class="subfolder-name">${subfolder.name}</div>
                <div class="subfolder-info">
                    ${folderInfo.join('')}
                </div>
            </div>
        `;

        return card;
    }
</script>

<style>
    /* Ensure lightbox image displays properly */
    #lightboxImage {
        display: block;
        width: auto;
        height: auto;
        max-width: 100%;
        max-height: 100%;
    }

    /* Make sure lightbox buttons are visible and properly styled */
    .lightbox-controls {
        z-index: 2001;
    }

    .lightbox-nav {
        z-index: 2001;
    }

    /* On mobile/touch devices, always show the controls */
    @media (hover: none) and (pointer: coarse) {

        .grid-item .image-controls,
        .grid-item .tag-circle-btn {
            opacity: 1 !important;
        }
    }

    /* Ensure buttons are clickable when visible */
    .grid-item .image-controls {
        pointer-events: auto;
    }

    .grid-item .image-controls button {
        pointer-events: auto;
    }
</style>
{% endblock %}